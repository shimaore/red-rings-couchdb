View dispatcher
---------------

    view_as_stream = (db_uri,app,view,key) ->

The `key` field (in the `SUBSCRIBE` message) is used to determine what type of query is performed:

      switch

- Map (JSON object) is used to provide one-time queries. These do not support `changes` streaming.

        when Immutable.Map.isMap key

For view queries we need to keep the original `key` field (for routing purposes).

          switch

For `group` queries we send the view's `key` in the `value` field of the message.

            when key.has 'level'
              group_as_stream db_uri,app,view,
                key.get('level'),
                key.get('min'),
                key.get('max')
              .tap (row) -> [ row.key, row.value ] = [ key, row.key ]

For count queries we set the `_key` field to the key generated by the view (the `value` field contains the view's `value`, i.e. the `count`).

            when key.has 'count'
              count_as_stream db_uri,app,view,
                key.get('count'),
                key.get('detail')
              .tap (row) ->
                if row.key?
                  [ row.key, row._key ] = [ key, row.key ]
                else
                  row.key = key

For range queries we set the `_key` field to the key generated by the view (the `value` field contains the view's `value`).

            when key.has('min') or key.has('max')
              range_as_stream db_uri,app,view,
                key.get('min'),
                key.get('max')
              .tap (row) -> [ row.key, row._key ] = [ key, row.key ]

            else
              most.empty()

- string, List, etc., generate regular view queries (and are subject to `changes` streaming, see `most-couchdb/changes-view`).

        else
          query_as_stream db_uri,app,view,key

    module.exports = view_as_stream
    query_as_stream = require './query'
    count_as_stream = require './count'
    range_as_stream = require './range'
    group_as_stream = require './group'
    most = require 'most'
    Immutable = require 'immutable'
